var Ft=Object.defineProperty;var zt=(te,Y,Z)=>Y in te?Ft(te,Y,{enumerable:!0,configurable:!0,writable:!0,value:Z}):te[Y]=Z;var R=(te,Y,Z)=>(zt(te,typeof Y!="symbol"?Y+"":Y,Z),Z);import{g as Ut}from"../lodash.BduLK7P_.js";var et={exports:{}};(function(te,Y){(function(Le,D){te.exports=D()})(self,()=>(()=>{var Z={46:i=>{var t=typeof Reflect=="object"?Reflect:null,n=t&&typeof t.apply=="function"?t.apply:function(r,p,_){return Function.prototype.apply.call(r,p,_)},e;t&&typeof t.ownKeys=="function"?e=t.ownKeys:Object.getOwnPropertySymbols?e=function(r){return Object.getOwnPropertyNames(r).concat(Object.getOwnPropertySymbols(r))}:e=function(r){return Object.getOwnPropertyNames(r)};function o(h){console&&console.warn&&console.warn(h)}var a=Number.isNaN||function(r){return r!==r};function u(){u.init.call(this)}i.exports=u,i.exports.once=_e,u.EventEmitter=u,u.prototype._events=void 0,u.prototype._eventsCount=0,u.prototype._maxListeners=void 0;var P=10;function T(h){if(typeof h!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof h)}Object.defineProperty(u,"defaultMaxListeners",{enumerable:!0,get:function(){return P},set:function(h){if(typeof h!="number"||h<0||a(h))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+h+".");P=h}}),u.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},u.prototype.setMaxListeners=function(r){if(typeof r!="number"||r<0||a(r))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+r+".");return this._maxListeners=r,this};function s(h){return h._maxListeners===void 0?u.defaultMaxListeners:h._maxListeners}u.prototype.getMaxListeners=function(){return s(this)},u.prototype.emit=function(r){for(var p=[],_=1;_<arguments.length;_++)p.push(arguments[_]);var E=r==="error",O=this._events;if(O!==void 0)E=E&&O.error===void 0;else if(!E)return!1;if(E){var S;if(p.length>0&&(S=p[0]),S instanceof Error)throw S;var j=new Error("Unhandled error."+(S?" ("+S.message+")":""));throw j.context=S,j}var se=O[r];if(se===void 0)return!1;if(typeof se=="function")n(se,this,p);else for(var ae=se.length,Ye=B(se,ae),_=0;_<ae;++_)n(Ye[_],this,p);return!0};function N(h,r,p,_){var E,O,S;if(T(p),O=h._events,O===void 0?(O=h._events=Object.create(null),h._eventsCount=0):(O.newListener!==void 0&&(h.emit("newListener",r,p.listener?p.listener:p),O=h._events),S=O[r]),S===void 0)S=O[r]=p,++h._eventsCount;else if(typeof S=="function"?S=O[r]=_?[p,S]:[S,p]:_?S.unshift(p):S.push(p),E=s(h),E>0&&S.length>E&&!S.warned){S.warned=!0;var j=new Error("Possible EventEmitter memory leak detected. "+S.length+" "+String(r)+" listeners added. Use emitter.setMaxListeners() to increase limit");j.name="MaxListenersExceededWarning",j.emitter=h,j.type=r,j.count=S.length,o(j)}return h}u.prototype.addListener=function(r,p){return N(this,r,p,!1)},u.prototype.on=u.prototype.addListener,u.prototype.prependListener=function(r,p){return N(this,r,p,!0)};function $(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function W(h,r,p){var _={fired:!1,wrapFn:void 0,target:h,type:r,listener:p},E=$.bind(_);return E.listener=p,_.wrapFn=E,E}u.prototype.once=function(r,p){return T(p),this.on(r,W(this,r,p)),this},u.prototype.prependOnceListener=function(r,p){return T(p),this.prependListener(r,W(this,r,p)),this},u.prototype.removeListener=function(r,p){var _,E,O,S,j;if(T(p),E=this._events,E===void 0)return this;if(_=E[r],_===void 0)return this;if(_===p||_.listener===p)--this._eventsCount===0?this._events=Object.create(null):(delete E[r],E.removeListener&&this.emit("removeListener",r,_.listener||p));else if(typeof _!="function"){for(O=-1,S=_.length-1;S>=0;S--)if(_[S]===p||_[S].listener===p){j=_[S].listener,O=S;break}if(O<0)return this;O===0?_.shift():Q(_,O),_.length===1&&(E[r]=_[0]),E.removeListener!==void 0&&this.emit("removeListener",r,j||p)}return this},u.prototype.off=u.prototype.removeListener,u.prototype.removeAllListeners=function(r){var p,_,E;if(_=this._events,_===void 0)return this;if(_.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):_[r]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete _[r]),this;if(arguments.length===0){var O=Object.keys(_),S;for(E=0;E<O.length;++E)S=O[E],S!=="removeListener"&&this.removeAllListeners(S);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=_[r],typeof p=="function")this.removeListener(r,p);else if(p!==void 0)for(E=p.length-1;E>=0;E--)this.removeListener(r,p[E]);return this};function F(h,r,p){var _=h._events;if(_===void 0)return[];var E=_[r];return E===void 0?[]:typeof E=="function"?p?[E.listener||E]:[E]:p?be(E):B(E,E.length)}u.prototype.listeners=function(r){return F(this,r,!0)},u.prototype.rawListeners=function(r){return F(this,r,!1)},u.listenerCount=function(h,r){return typeof h.listenerCount=="function"?h.listenerCount(r):z.call(h,r)},u.prototype.listenerCount=z;function z(h){var r=this._events;if(r!==void 0){var p=r[h];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}u.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]};function B(h,r){for(var p=new Array(r),_=0;_<r;++_)p[_]=h[_];return p}function Q(h,r){for(;r+1<h.length;r++)h[r]=h[r+1];h.pop()}function be(h){for(var r=new Array(h.length),p=0;p<r.length;++p)r[p]=h[p].listener||h[p];return r}function _e(h,r){return new Promise(function(p,_){function E(S){h.removeListener(r,O),_(S)}function O(){typeof h.removeListener=="function"&&h.removeListener("error",E),p([].slice.call(arguments))}ye(h,r,O,{once:!0}),r!=="error"&&Pe(h,E,{once:!0})})}function Pe(h,r,p){typeof h.on=="function"&&ye(h,"error",r,p)}function ye(h,r,p,_){if(typeof h.on=="function")_.once?h.once(r,p):h.on(r,p);else if(typeof h.addEventListener=="function")h.addEventListener(r,function E(O){_.once&&h.removeEventListener(r,E),p(O)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof h)}}},Le={};function D(i){var t=Le[i];if(t!==void 0)return t.exports;var n=Le[i]={exports:{}};return Z[i](n,n.exports,D),n.exports}D.n=i=>{var t=i&&i.__esModule?()=>i.default:()=>i;return D.d(t,{a:t}),t},D.d=(i,t)=>{for(var n in t)D.o(t,n)&&!D.o(i,n)&&Object.defineProperty(i,n,{enumerable:!0,get:t[n]})},D.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch{if(typeof window=="object")return window}}(),D.o=(i,t)=>Object.prototype.hasOwnProperty.call(i,t);var fe={};D.d(fe,{default:()=>At});const M={BOOTSTRAP:"popup-bootstrap",LOADED:"popup-loaded",CORE_LOADED:"popup-core-loaded",INIT:"popup-init",ERROR:"popup-error",EXTENSION_USB_PERMISSIONS:"open-usb-permissions",HANDSHAKE:"popup-handshake",CLOSED:"popup-closed",CANCEL_POPUP_REQUEST:"ui-cancel-popup-request",CLOSE_WINDOW:"window.close",ANALYTICS_RESPONSE:"popup-analytics-response",CONTENT_SCRIPT_LOADED:"popup-content-script-loaded",METHOD_INFO:"popup-method-info"},Oe="UI_EVENT",V={...{TRANSPORT:"ui-no_transport",BOOTLOADER:"ui-device_bootloader_mode",NOT_IN_BOOTLOADER:"ui-device_not_in_bootloader_mode",REQUIRE_MODE:"ui-device_require_mode",INITIALIZE:"ui-device_not_initialized",SEEDLESS:"ui-device_seedless",FIRMWARE_OLD:"ui-device_firmware_old",FIRMWARE_OUTDATED:"ui-device_firmware_outdated",FIRMWARE_NOT_SUPPORTED:"ui-device_firmware_unsupported",FIRMWARE_NOT_COMPATIBLE:"ui-device_firmware_not_compatible",FIRMWARE_NOT_INSTALLED:"ui-device_firmware_not_installed",FIRMWARE_PROGRESS:"ui-firmware-progress",FIRMWARE_RECONNECT:"ui-firmware_reconnect",DEVICE_NEEDS_BACKUP:"ui-device_needs_backup",REQUEST_UI_WINDOW:"ui-request_window",CLOSE_UI_WINDOW:"ui-close_window",REQUEST_PERMISSION:"ui-request_permission",REQUEST_CONFIRMATION:"ui-request_confirmation",REQUEST_PIN:"ui-request_pin",INVALID_PIN:"ui-invalid_pin",REQUEST_PASSPHRASE:"ui-request_passphrase",REQUEST_PASSPHRASE_ON_DEVICE:"ui-request_passphrase_on_device",INVALID_PASSPHRASE:"ui-invalid_passphrase",CONNECT:"ui-connect",LOADING:"ui-loading",SET_OPERATION:"ui-set_operation",SELECT_DEVICE:"ui-select_device",SELECT_ACCOUNT:"ui-select_account",SELECT_FEE:"ui-select_fee",UPDATE_CUSTOM_FEE:"ui-update_custom_fee",INSUFFICIENT_FUNDS:"ui-insufficient_funds",REQUEST_BUTTON:"ui-button",REQUEST_WORD:"ui-request_word",LOGIN_CHALLENGE_REQUEST:"ui-login_challenge_request",BUNDLE_PROGRESS:"ui-bundle_progress",ADDRESS_VALIDATION:"ui-address_validation",IFRAME_FAILURE:"ui-iframe_failure"},...{RECEIVE_PERMISSION:"ui-receive_permission",RECEIVE_CONFIRMATION:"ui-receive_confirmation",RECEIVE_PIN:"ui-receive_pin",RECEIVE_PASSPHRASE:"ui-receive_passphrase",RECEIVE_DEVICE:"ui-receive_device",RECEIVE_ACCOUNT:"ui-receive_account",RECEIVE_FEE:"ui-receive_fee",RECEIVE_WORD:"ui-receive_word",INVALID_PASSPHRASE_ACTION:"ui-invalid_passphrase_action",CHANGE_SETTINGS:"ui-change_settings",LOGIN_CHALLENGE_RESPONSE:"ui-login_challenge_response"}},Me=({eventEmitter:i,manifest:t,init:n,call:e,requestLogin:o,uiResponse:a,cancel:u,dispose:P},T={})=>({manifest:t,init:n,on:(s,N)=>{i.on(s,N)},off:(s,N)=>{i.removeListener(s,N)},removeAllListeners:s=>{typeof s=="string"?i.removeAllListeners(s):i.removeAllListeners()},uiResponse:a,blockchainGetAccountBalanceHistory:s=>e({...s,method:"blockchainGetAccountBalanceHistory"}),blockchainGetCurrentFiatRates:s=>e({...s,method:"blockchainGetCurrentFiatRates"}),blockchainGetFiatRatesForTimestamps:s=>e({...s,method:"blockchainGetFiatRatesForTimestamps"}),blockchainGetInfo:s=>e({...s,method:"blockchainGetInfo"}),blockchainEvmRpcCall:s=>e({...s,method:"blockchainEvmRpcCall"}),blockchainDisconnect:s=>e({...s,method:"blockchainDisconnect"}),blockchainEstimateFee:s=>e({...s,method:"blockchainEstimateFee"}),blockchainGetTransactions:s=>e({...s,method:"blockchainGetTransactions"}),blockchainSetCustomBackend:s=>e({...s,method:"blockchainSetCustomBackend"}),blockchainSubscribe:s=>e({...s,method:"blockchainSubscribe"}),blockchainSubscribeFiatRates:s=>e({...s,method:"blockchainSubscribeFiatRates"}),blockchainUnsubscribe:s=>e({...s,method:"blockchainUnsubscribe"}),blockchainUnsubscribeFiatRates:s=>e({...s,method:"blockchainUnsubscribeFiatRates"}),requestLogin:s=>o(s),cardanoGetAddress:s=>e({...s,method:"cardanoGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),cardanoGetNativeScriptHash:s=>e({...s,method:"cardanoGetNativeScriptHash"}),cardanoGetPublicKey:s=>e({...s,method:"cardanoGetPublicKey"}),cardanoSignTransaction:s=>e({...s,method:"cardanoSignTransaction"}),cardanoComposeTransaction:s=>e({...s,method:"cardanoComposeTransaction"}),cipherKeyValue:s=>e({...s,method:"cipherKeyValue"}),composeTransaction:s=>e({...s,method:"composeTransaction"}),ethereumGetAddress:s=>e({...s,method:"ethereumGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),ethereumGetPublicKey:s=>e({...s,method:"ethereumGetPublicKey"}),ethereumSignMessage:s=>e({...s,method:"ethereumSignMessage"}),ethereumSignTransaction:s=>e({...s,method:"ethereumSignTransaction"}),ethereumSignTypedData:s=>e({...s,method:"ethereumSignTypedData"}),ethereumVerifyMessage:s=>e({...s,method:"ethereumVerifyMessage"}),getAccountDescriptor:s=>e({...s,method:"getAccountDescriptor"}),getAccountInfo:s=>e({...s,method:"getAccountInfo"}),getAddress:s=>e({...s,method:"getAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),getDeviceState:s=>e({...s,method:"getDeviceState"}),getFeatures:s=>e({...s,method:"getFeatures"}),getFirmwareHash:s=>e({...s,method:"getFirmwareHash"}),getOwnershipId:s=>e({...s,method:"getOwnershipId"}),getOwnershipProof:s=>e({...s,method:"getOwnershipProof"}),getPublicKey:s=>e({...s,method:"getPublicKey"}),nemGetAddress:s=>e({...s,method:"nemGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),nemSignTransaction:s=>e({...s,method:"nemSignTransaction"}),pushTransaction:s=>e({...s,method:"pushTransaction"}),rippleGetAddress:s=>e({...s,method:"rippleGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),rippleSignTransaction:s=>e({...s,method:"rippleSignTransaction"}),signMessage:s=>e({...s,method:"signMessage"}),signTransaction:s=>e({...s,method:"signTransaction"}),solanaGetPublicKey:s=>e({...s,method:"solanaGetPublicKey"}),solanaGetAddress:s=>e({...s,method:"solanaGetAddress"}),solanaSignTransaction:s=>e({...s,method:"solanaSignTransaction"}),stellarGetAddress:s=>e({...s,method:"stellarGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),stellarSignTransaction:s=>e({...s,method:"stellarSignTransaction"}),tezosGetAddress:s=>e({...s,method:"tezosGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),tezosGetPublicKey:s=>e({...s,method:"tezosGetPublicKey"}),tezosSignTransaction:s=>e({...s,method:"tezosSignTransaction"}),unlockPath:s=>e({...s,method:"unlockPath"}),eosGetPublicKey:s=>e({...s,method:"eosGetPublicKey"}),eosSignTransaction:s=>e({...s,method:"eosSignTransaction"}),binanceGetAddress:s=>e({...s,method:"binanceGetAddress",useEventListener:i.listenerCount(V.ADDRESS_VALIDATION)>0}),binanceGetPublicKey:s=>e({...s,method:"binanceGetPublicKey"}),binanceSignTransaction:s=>e({...s,method:"binanceSignTransaction"}),verifyMessage:s=>e({...s,method:"verifyMessage"}),resetDevice:s=>e({...s,method:"resetDevice"}),loadDevice:s=>e({...s,method:"loadDevice"}),wipeDevice:s=>e({...s,method:"wipeDevice"}),applyFlags:s=>e({...s,method:"applyFlags"}),applySettings:s=>e({...s,method:"applySettings"}),getSettings:()=>e({method:"getSettings"}),authenticateDevice:s=>e({...s,method:"authenticateDevice"}),authorizeCoinjoin:s=>e({...s,method:"authorizeCoinjoin"}),cancelCoinjoinAuthorization:s=>e({...s,method:"cancelCoinjoinAuthorization"}),showDeviceTutorial:s=>e({...s,method:"showDeviceTutorial"}),backupDevice:s=>e({...s,method:"backupDevice"}),changeLanguage:s=>e({...s,method:"changeLanguage"}),changePin:s=>e({...s,method:"changePin"}),changeWipeCode:s=>e({...s,method:"changeWipeCode"}),firmwareUpdate:s=>e({...s,method:"firmwareUpdate"}),recoveryDevice:s=>e({...s,method:"recoveryDevice"}),getCoinInfo:s=>e({...s,method:"getCoinInfo"}),setBrightness:s=>e({...s,method:"setBrightness"}),setBusy:s=>e({...s,method:"setBusy"}),setProxy:s=>e({...s,method:"setProxy"}),dispose:P,cancel:u,...T});class tt{constructor(t,n,e){R(this,"css","");R(this,"MAX_ENTRIES",100);this.prefix=t,this.enabled=n,this.messages=[],e&&(this.logWriter=e)}setColors(t){this.css=typeof window<"u"&&t[this.prefix]?t[this.prefix]:""}addMessage({level:t,prefix:n,timestamp:e},...o){const a={level:t,prefix:n,css:this.css,message:o,timestamp:e||Date.now()};if(this.messages.push(a),this.logWriter)try{this.logWriter.add(a)}catch(u){console.error("There was an error adding log message",u,a)}this.messages.length>this.MAX_ENTRIES&&this.messages.shift()}setWriter(t){this.logWriter=t}log(...t){this.addMessage({level:"log",prefix:this.prefix},...t),this.enabled&&console.log(`%c${this.prefix}`,this.css,...t)}error(...t){this.addMessage({level:"error",prefix:this.prefix},...t),this.enabled&&console.error(`%c${this.prefix}`,this.css,...t)}info(...t){this.addMessage({level:"info",prefix:this.prefix},...t),this.enabled&&console.info(`%c${this.prefix}`,this.css,...t)}warn(...t){this.addMessage({level:"warn",prefix:this.prefix},...t),this.enabled&&console.warn(`%c${this.prefix}`,this.css,...t)}debug(...t){this.addMessage({level:"debug",prefix:this.prefix},...t),this.enabled&&(this.css?console.log(`%c${this.prefix}`,this.css,...t):console.log(this.prefix,...t))}getLog(){return this.messages}}class nt{constructor({colors:t}){R(this,"logs",{});R(this,"colors",{});this.colors=t}initLog(t,n,e){const o=e||this.writer,a=new tt(t,!!n,o);return this.colors&&a.setColors(this.colors),this.logs[t]=a,a}setLogWriter(t){Object.keys(this.logs).forEach(n=>{if(this.writer=t(),this.writer){this.logs[n].setWriter(this.writer);const{messages:e}=this.logs[n];e.forEach(o=>{var a;(a=this.writer)==null||a.add(o)})}})}enableLog(t){Object.keys(this.logs).forEach(n=>{this.logs[n].enabled=!!t})}enableLogByPrefix(t,n){this.logs[t]&&(this.logs[t].enabled=n)}getLog(){let t=[];return Object.keys(this.logs).forEach(n=>{t=t.concat(this.logs[n].messages)}),t.sort((n,e)=>n.timestamp-e.timestamp),t}}const he="#bada55",Se="#20abd8",Ae="#f4a744",st={"@trezor/connect":`color: ${Se}; background: #000;`,"@trezor/connect-web":`color: ${Se}; background: #000;`,"@trezor/connect-webextension":`color: ${Se}; background: #000;`,IFrame:`color: ${Ae}; background: #000;`,Core:`color: ${Ae}; background: #000;`,DeviceList:`color: ${he}; background: #000;`,Device:`color: ${he}; background: #000;`,DeviceCommands:`color: ${he}; background: #000;`,"@trezor/transport":`color: ${he}; background: #000;`,InteractionTimeout:`color: ${he}; background: #000;`,"@trezor/connect-popup":"color: #fbd948; background: #000;"},q=new nt({colors:st}),me=q.initLog.bind(q),it=q.setLogWriter.bind(q);q.enableLog.bind(q),q.enableLogByPrefix.bind(q),q.getLog.bind(q);var Re=D(46),De=D.n(Re);class ke extends Re.EventEmitter{listenerCount(t){return super.listenerCount(t)}}const xe="storage_v2",Ne=()=>({origin:{}});let oe=Ne();const We=()=>{const i=localStorage.getItem(xe);return i?JSON.parse(i):Ne()};class ot extends ke{save(t,n=!1){if(n||!D.g.window){oe=t(oe);return}try{const e=t(We());localStorage.setItem(xe,JSON.stringify(e)),this.emit("changed",e)}catch{console.warn("long term storage not available"),oe=t(oe)}}saveForOrigin(t,n,e=!1){this.save(o=>{var a;return{...o,origin:{...o.origin,[n]:t(((a=o.origin)==null?void 0:a[n])||{})}}},e)}load(t=!1){var n,e;if(t||!((e=(n=D.g)==null?void 0:n.window)!=null&&e.localStorage))return oe;try{return We()}catch{return console.warn("long term storage not available"),oe}}loadForOrigin(t,n=!1){var o;return((o=this.load(n).origin)==null?void 0:o[t])||{}}}new ot;const ne=i=>{let t=()=>{},n=()=>{};const e=new Promise((o,a)=>{t=o,n=a});return{id:i,resolve:t,reject:n,promise:e}},Fe=i=>Array.isArray(i),ze=()=>new Error("Aborted by signal"),rt=()=>new Error("Aborted by deadline"),at=()=>new Error("Aborted by timeout"),Ue=(i,t)=>new Promise((n,e)=>{if(t.aborted)return e();if(i===void 0)return n();let o;const a=()=>{clearTimeout(o),t.removeEventListener("abort",a),e()};o=setTimeout(()=>{t.removeEventListener("abort",a),n()},i),t.addEventListener("abort",a)}),ct=(i,t,n)=>new Promise((e,o)=>{if(n.aborted)return o();let a;const u=()=>{clearTimeout(a),n.removeEventListener("abort",u),o()};a=setTimeout(()=>{n.removeEventListener("abort",u),o(t())},i),n.addEventListener("abort",u)}),je=(i,t,n)=>i===void 0?[]:[ct(i,t,n)],ht=(i,t)=>new Promise((n,e)=>{if(t.aborted)return e();if(i!=null&&i.aborted)return e(ze());const o=()=>e(ze());i==null||i.addEventListener("abort",o);const a=()=>{i==null||i.removeEventListener("abort",o),t.removeEventListener("abort",a),e()};t.addEventListener("abort",a)}),dt=async(i,t)=>{const n=new AbortController;t.aborted&&n.abort();const e=()=>{t.removeEventListener("abort",e),n.abort()};t.addEventListener("abort",e);try{return await new Promise(o=>o(i(n.signal)))}finally{t.aborted||t.removeEventListener("abort",e)}},ut=async(i,t,n,e)=>{for(let o=0;o<i-1&&!e.aborted;o++){const a=new AbortController,u=()=>a.abort();e.addEventListener("abort",u);try{return await t(o,a.signal)}catch(P){u(),await n(o,P)}finally{e.removeEventListener("abort",u)}}return e.aborted?Promise.reject():t(i-1,e)},Be=async(i,t)=>{const{signal:n,delay:e,attempts:o,timeout:a,deadline:u,gap:P,attemptFailureHandler:T}=t,s=u&&u-Date.now(),N=Fe(o)?o.length:o??(u?1/0:1),$=new AbortController,W=$.signal,F=Fe(o)?z=>o[z]:()=>({timeout:a,gap:P});try{return await Promise.race([ht(n,W),...je(s,rt,W),Ue(e,W).then(()=>ut(N,(z,B)=>Promise.race([...je(F(z).timeout,at,W),dt(i,B)]),(z,B)=>{const Q=T==null?void 0:T(B);return Q?Promise.reject(Q):Ue(F(z).gap??0,W)},W))])}finally{$.abort()}};class He extends ke{constructor({sendFn:n,channel:e,logger:o,lazyHandshake:a=!1,legacyMode:u=!1}){super();R(this,"messagePromises",{});R(this,"messagesQueue",[]);R(this,"messageID",0);R(this,"isConnected",!1);R(this,"handshakeMaxRetries",5);R(this,"handshakeRetryInterval",2e3);this.channel=e,this.sendFn=n,this.lazyHandshake=a,this.legacyMode=u,this.logger=o}init(){return this.handshakeFinished||(this.handshakeFinished=ne(),this.legacyMode&&setTimeout(()=>{var n;(n=this.handshakeFinished)==null||n.resolve()},500),this.lazyHandshake||this.handshakeWithPeer()),this.handshakeFinished.promise}handshakeWithPeer(){var n;return(n=this.logger)==null||n.log(this.channel.here,"handshake"),Be(async()=>{var e;this.postMessage({type:"channel-handshake-request",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),await((e=this.handshakeFinished)==null?void 0:e.promise)},{attempts:this.handshakeMaxRetries,timeout:this.handshakeRetryInterval}).then(()=>{var e;(e=this.logger)==null||e.log(this.channel.here,"handshake confirmed"),this.messagesQueue.forEach(o=>{o.channel=this.channel,this.sendFn(o)}),this.messagesQueue=[]}).catch(()=>{var e;(e=this.handshakeFinished)==null||e.reject(new Error("handshake failed")),this.handshakeFinished=void 0})}onMessage(n){var s,N;let e=n;this.legacyMode&&e.type===void 0&&"data"in e&&typeof e.data=="object"&&e.data!==null&&"type"in e.data&&typeof e.data.type=="string"&&(e=e.data);const{channel:o,id:a,type:u,...P}=e;if(!this.legacyMode&&(!(o!=null&&o.peer)||o.peer!==this.channel.here||!(o!=null&&o.here)||this.channel.peer!==o.here))return;if(u==="channel-handshake-request"){this.postMessage({type:"channel-handshake-confirm",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),this.lazyHandshake&&this.handshakeWithPeer();return}if(u==="channel-handshake-confirm"){(s=this.handshakeFinished)==null||s.resolve(void 0);return}this.messagePromises[a]&&(this.messagePromises[a].resolve({id:a,...P}),delete this.messagePromises[a]);const T=Object.keys(this.messagePromises).length;T>5&&((N=this.logger)==null||N.warn(`too many message promises (${T}). this feels unexpected!`)),this.emit("message",e)}postMessage(n,{usePromise:e=!0,useQueue:o=!0}={}){if(n.channel=this.channel,!e){try{this.sendFn(n)}catch{o&&this.messagesQueue.push(n)}return}this.messageID++,n.id=this.messageID,this.messagePromises[n.id]=ne();try{this.sendFn(n)}catch{o&&this.messagesQueue.push(n)}return this.messagePromises[n.id].promise}resolveMessagePromises(n){Object.keys(this.messagePromises).forEach(e=>this.messagePromises[e].resolve({id:e,payload:n}))}clear(){this.handshakeFinished=void 0}}class Ge extends He{constructor({name:t,channel:n,logger:e,lazyHandshake:o,legacyMode:a,allowSelfOrigin:u=!1,currentId:P}){super({channel:n,sendFn:T=>{if(!this.port)throw new Error("port not assigned");this.port.postMessage(T)},logger:e,lazyHandshake:o,legacyMode:a}),this.name=t,this.allowSelfOrigin=u,this.currentId=P,this.connect()}connect(){chrome.runtime.onConnect.addListener(t=>{var n,e,o,a;t.name===this.name&&((n=this.currentId)!=null&&n.call(this)&&((e=this.currentId)==null?void 0:e.call(this))!==((a=(o=t.sender)==null?void 0:o.tab)==null?void 0:a.id)||(this.port=t,this.port.onMessage.addListener((u,{sender:P})=>{var W,F,z,B,Q;if(!P){(W=this.logger)==null||W.error("service-worker-window","no sender");return}const{origin:T}=P,s=["https://connect.trezor.io","https://staging-connect.trezor.io","https://suite.corp.sldev.cz","https://dev.suite.sldev.cz","http://localhost:8088"],N=(F=chrome==null?void 0:chrome.runtime)==null?void 0:F.id;N&&s.push(`chrome-extension://${N}`);const $=(z=chrome==null?void 0:chrome.runtime)==null?void 0:z.getURL("");if($&&s.push($.slice(0,-1)),!T){(B=this.logger)==null||B.error("connect-webextension/messageChannel/extensionPort/onMessage","no origin");return}if(!s.includes(T)){(Q=this.logger)==null||Q.error("connect-webextension/messageChannel/extensionPort/onMessage","origin not whitelisted",T);return}T===self.origin&&!this.allowSelfOrigin||this.onMessage(u)})))}),this.isConnected=!0}disconnect(){var t;this.isConnected&&((t=this.port)==null||t.disconnect(),this.clear(),this.isConnected=!1)}}const ge={BOOTSTRAP:"iframe-bootstrap",LOADED:"iframe-loaded",INIT:"iframe-init",ERROR:"iframe-error",CALL:"iframe-call",LOG:"iframe-log"},Ve=i=>({success:!1,payload:{error:i.message,code:i.code}}),pt={Init_NotInitialized:"TrezorConnect not initialized",Init_AlreadyInitialized:"TrezorConnect has been already initialized",Init_IframeBlocked:"Iframe blocked",Init_IframeTimeout:"Iframe timeout",Init_ManifestMissing:"Manifest not set. Read more at https://github.com/trezor/trezor-suite/blob/develop/docs/packages/connect/index.md",Popup_ConnectionMissing:"Unable to establish connection with iframe",Transport_Missing:"Transport is missing",Transport_InvalidProtobuf:"",Method_InvalidPackage:"This package is not suitable to work with browser. Use @trezor/connect-web package instead",Method_InvalidParameter:"",Method_NotAllowed:"Method not allowed for this configuration",Method_PermissionsNotGranted:"Permissions not granted",Method_Cancel:"Cancelled",Method_Interrupted:"Popup closed",Method_UnknownCoin:"Coin not found",Method_AddressNotMatch:"Addresses do not match",Method_FirmwareUpdate_DownloadFailed:"Failed to download firmware binary",Method_Discovery_BundleException:"",Method_Override:"override",Method_NoResponse:"Call resolved without response",Backend_NotSupported:"BlockchainLink settings not found in coins.json",Backend_WorkerMissing:"",Backend_Disconnected:"Backend disconnected",Backend_Invalid:"Invalid backend",Backend_Error:"",Runtime:"",Device_NotFound:"Device not found",Device_InitializeFailed:"",Device_FwException:"",Device_ModeException:"",Device_Disconnected:"Device disconnected",Device_UsedElsewhere:"Device is used in another window",Device_InvalidState:"Passphrase is incorrect",Device_CallInProgress:"Device call in progress",Device_MultipleNotSupported:"Multiple devices are not supported",Device_MissingCapability:"Device is missing capability",Device_MissingCapabilityBtcOnly:"Device is missing capability (BTC only)",Failure_ActionCancelled:"Action cancelled by user",Failure_FirmwareError:"Firmware installation failed",Failure_UnknownCode:"Unknown error",Failure_PinCancelled:"PIN cancelled",Failure_PinInvalid:"PIN invalid",Failure_PinMismatch:"PIN mismatch",Failure_WipeCodeMismatch:"Wipe code mismatch",Deeplink_VersionMismatch:"Not compatible with current version of the app"};class lt extends Error{constructor(t,n){super(n),this.code=t,this.message=n}}const X=(i,t)=>new lt(i,t||pt[i]),de="9.4.5",ft=de.split(".").map(i=>parseInt(i,10)),re=de.includes("beta")?`https://connect.trezor.io/${de}/`:`https://connect.trezor.io/${ft[0]}/`,Ce=1,qe=1,mt={configSrc:"./data/config.json",version:de,debug:!1,priority:2,trustedHost:!0,connectSrc:re,iframeSrc:`${re}iframe.html`,popup:!1,popupSrc:`${re}popup.html`,webusbSrc:`${re}webusb.html`,transports:void 0,pendingTransportEvent:!0,env:"node",lazyLoad:!1,timestamp:new Date().getTime(),interactionTimeout:600,sharedLogger:!0,deeplinkUrl:`${re}deeplink/${qe}/`,transportReconnect:!0},gt=i=>{if(i&&typeof i.email=="string"&&typeof i.appUrl=="string")return{email:i.email,appUrl:i.appUrl}},vt=i=>{if(typeof i=="string"&&(i.match(/^https:\/\/([A-Za-z0-9\-_]+\.)*trezor\.io\//)||i.match(/^https?:\/\/localhost:[58][0-9]{3}\//)||i.match(/^https:\/\/([A-Za-z0-9\-_]+\.)*sldev\.cz\//)||i.match(/^https?:\/\/([A-Za-z0-9\-_]+\.)*trezoriovpjcahpzkrewelclulmszwbqpzmzgub37gbcjlvluxtruqad\.onion\//)))return i},$e=(i={})=>{var e;const t={...mt};"debug"in i&&(typeof i.debug=="boolean"?t.debug=i.debug:typeof i.debug=="string"&&(t.debug=i.debug==="true")),i.trustedHost===!1&&(t.trustedHost=i.trustedHost),typeof i.connectSrc=="string"&&((e=i.connectSrc)!=null&&e.startsWith("http"))?t.connectSrc=vt(i.connectSrc):t.trustedHost&&(t.connectSrc=i.connectSrc);const n=t.connectSrc||re;return t.iframeSrc=`${n}iframe.html`,t.popupSrc=`${n}popup.html`,t.webusbSrc=`${n}webusb.html`,t.deeplinkUrl=`${n}deeplink/${qe}/`,typeof i.transportReconnect=="boolean"&&(t.transportReconnect=i.transportReconnect),Array.isArray(i.transports)&&(t.transports=i.transports),typeof i.popup=="boolean"&&(t.popup=i.popup),typeof i.lazyLoad=="boolean"&&(t.lazyLoad=i.lazyLoad),typeof i.pendingTransportEvent=="boolean"&&(t.pendingTransportEvent=i.pendingTransportEvent),typeof i.extension=="string"&&(t.extension=i.extension),typeof i.env=="string"&&(t.env=i.env),typeof i.timestamp=="number"&&(t.timestamp=i.timestamp),typeof i.interactionTimeout=="number"&&(t.interactionTimeout=i.interactionTimeout),typeof i.manifest=="object"&&(t.manifest=gt(i.manifest)),typeof i.sharedLogger=="boolean"&&(t.sharedLogger=i.sharedLogger),typeof i.coreMode=="string"&&["auto","popup","iframe"].includes(i.coreMode)&&(t.coreMode=i.coreMode),typeof i._extendWebextensionLifetime=="boolean"&&(t._extendWebextensionLifetime=i._extendWebextensionLifetime),(typeof i._sessionsBackgroundUrl=="string"||i._sessionsBackgroundUrl===null)&&(t._sessionsBackgroundUrl=i._sessionsBackgroundUrl),typeof i.binFilesBaseUrl=="string"&&(t.binFilesBaseUrl=i.binFilesBaseUrl),typeof i.enableFirmwareHashCheck=="boolean"&&(t.enableFirmwareHashCheck=!!i.enableFirmwareHashCheck),t},bt=()=>{var i;if(typeof chrome<"u"&&typeof((i=chrome.runtime)==null?void 0:i.onConnect)<"u")return"webextension";if(typeof navigator<"u"){if(typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative")return"react-native";if(navigator.userAgent.toLowerCase().indexOf(" electron/")>-1)return"electron"}return"web"},_t=(i,t)=>{const n=new URLSearchParams(i),e={};return Array.from(n.entries()).forEach(([a,u])=>{t.includes(a)&&(e[a]=decodeURIComponent(u))}),e},ue=(i={})=>{var e;const t={popup:!0,...i};let n;if(typeof window<"u"?n=window.__TREZOR_CONNECT_SRC:typeof D.g<"u"&&(n=D.g.__TREZOR_CONNECT_SRC),typeof n=="string"&&(t.connectSrc=n,t.debug=!0),typeof window<"u"&&typeof((e=window.location)==null?void 0:e.search)=="string"){const o=_t(window.location.search,["trezor-connect-src"]);o["trezor-connect-src"]&&(t.debug=!0,t.connectSrc=o["trezor-connect-src"])}return typeof i.env!="string"&&(t.env=bt()),$e(t)},yt=i=>{if(typeof i!="string")return"unknown";if(i.indexOf("file://")===0)return"file://";const[t]=i.match(/^https?:\/\/[^/]+/)??[];return t??"unknown"},Ie="TrezorConnectInteractionLayer",wt=`
    <div class="trezorconnect-container" id="${Ie}">
        <div class="trezorconnect-window">
            <div class="trezorconnect-head">
                <svg class="trezorconnect-logo" x="0px" y="0px" viewBox="0 0 163.7 41.9" width="78px" height="20px" preserveAspectRatio="xMinYMin meet">
                    <polygon points="101.1,12.8 118.2,12.8 118.2,17.3 108.9,29.9 118.2,29.9 118.2,35.2 101.1,35.2 101.1,30.7 110.4,18.1 101.1,18.1"/>
                    <path d="M158.8,26.9c2.1-0.8,4.3-2.9,4.3-6.6c0-4.5-3.1-7.4-7.7-7.4h-10.5v22.3h5.8v-7.5h2.2l4.1,7.5h6.7L158.8,26.9z M154.7,22.5 h-4V18h4c1.5,0,2.5,0.9,2.5,2.2C157.2,21.6,156.2,22.5,154.7,22.5z"/>
                    <path d="M130.8,12.5c-6.8,0-11.6,4.9-11.6,11.5s4.9,11.5,11.6,11.5s11.7-4.9,11.7-11.5S137.6,12.5,130.8,12.5z M130.8,30.3 c-3.4,0-5.7-2.6-5.7-6.3c0-3.8,2.3-6.3,5.7-6.3c3.4,0,5.8,2.6,5.8,6.3C136.6,27.7,134.2,30.3,130.8,30.3z"/>
                    <polygon points="82.1,12.8 98.3,12.8 98.3,18 87.9,18 87.9,21.3 98,21.3 98,26.4 87.9,26.4 87.9,30 98.3,30 98.3,35.2 82.1,35.2 "/>
                    <path d="M24.6,9.7C24.6,4.4,20,0,14.4,0S4.2,4.4,4.2,9.7v3.1H0v22.3h0l14.4,6.7l14.4-6.7h0V12.9h-4.2V9.7z M9.4,9.7 c0-2.5,2.2-4.5,5-4.5s5,2,5,4.5v3.1H9.4V9.7z M23,31.5l-8.6,4l-8.6-4V18.1H23V31.5z"/>
                    <path d="M79.4,20.3c0-4.5-3.1-7.4-7.7-7.4H61.2v22.3H67v-7.5h2.2l4.1,7.5H80l-4.9-8.3C77.2,26.1,79.4,24,79.4,20.3z M71,22.5h-4V18 h4c1.5,0,2.5,0.9,2.5,2.2C73.5,21.6,72.5,22.5,71,22.5z"/>
                    <polygon points="40.5,12.8 58.6,12.8 58.6,18.1 52.4,18.1 52.4,35.2 46.6,35.2 46.6,18.1 40.5,18.1 "/>
                </svg>
                <div class="trezorconnect-close">
                    <svg x="0px" y="0px" viewBox="24 24 60 60" width="24px" height="24px" preserveAspectRatio="xMinYMin meet">
                        <polygon class="st0" points="40,67.9 42.1,70 55,57.1 67.9,70 70,67.9 57.1,55 70,42.1 67.9,40 55,52.9 42.1,40 40,42.1 52.9,55 "/>
                    </svg>
                </div>
            </div>
            <div class="trezorconnect-body">
                <h3>Popup was blocked</h3>
                <p>Please click to "Continue" to open popup manually</p>
                <button class="trezorconnect-open">Continue</button>
            </div>
        </div>
    </div>
`,Qe=(i,t)=>{if(document.getElementById(Ie))return;const n=document.createElement("div");n.id=Ie,n.className="trezorconnect-container",n.innerHTML=wt,document.body&&document.body.appendChild(n);const e=n.getElementsByClassName("trezorconnect-open")[0];e.onclick=()=>{i(),document.body&&document.body.removeChild(n)};const o=n.getElementsByClassName("trezorconnect-close")[0];o.onclick=()=>{t(),document.body&&document.body.removeChild(n)}};class Ke extends He{constructor({windowHere:t,windowPeer:n,channel:e,logger:o,origin:a,legacyMode:u}){super({channel:e,sendFn:P=>{var T;(T=n())==null||T.postMessage(P,a)},logger:o,legacyMode:u}),this._listener=this.listener.bind(this),this._windowHere=t,this.connect()}listener(t){const n={...t.data,success:!0,origin:t.origin,payload:t.data.payload||{},channel:t.data.channel||{peer:this.channel.here,here:this.channel.peer}};this.onMessage(n)}connect(){this._windowHere.addEventListener("message",this._listener),this.isConnected=!0}disconnect(){this.isConnected&&(this._windowHere.removeEventListener("message",this._listener),this.isConnected=!1)}}const Et=i=>new Promise(t=>{if(!i)return t(!1);function n(){chrome.runtime.lastError?t(!1):t(!0)}chrome.tabs.get(i,n)}),Lt=850,St=500,Ct=5e3;class It extends De(){constructor(n,{logger:e}){var o;super();R(this,"locked",!1);R(this,"extensionTabId",0);R(this,"injectContentScript",n=>{chrome.permissions.getAll(e=>{var o;(o=e.permissions)!=null&&o.includes("scripting")&&Be(()=>chrome.scripting.executeScript({target:{tabId:n},func:()=>{(()=>{var a={46:w=>{var g=typeof Reflect=="object"?Reflect:null,l=g&&typeof g.apply=="function"?g.apply:function(c,m,y){return Function.prototype.apply.call(c,m,y)},f;g&&typeof g.ownKeys=="function"?f=g.ownKeys:Object.getOwnPropertySymbols?f=function(c){return Object.getOwnPropertyNames(c).concat(Object.getOwnPropertySymbols(c))}:f=function(c){return Object.getOwnPropertyNames(c)};function b(d){console&&console.warn&&console.warn(d)}var I=Number.isNaN||function(c){return c!==c};function v(){v.init.call(this)}w.exports=v,w.exports.once=xt,v.EventEmitter=v,v.prototype._events=void 0,v.prototype._eventsCount=0,v.prototype._maxListeners=void 0;var H=10;function U(d){if(typeof d!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof d)}Object.defineProperty(v,"defaultMaxListeners",{enumerable:!0,get:function(){return H},set:function(d){if(typeof d!="number"||d<0||I(d))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+d+".");H=d}}),v.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},v.prototype.setMaxListeners=function(c){if(typeof c!="number"||c<0||I(c))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+c+".");return this._maxListeners=c,this};function K(d){return d._maxListeners===void 0?v.defaultMaxListeners:d._maxListeners}v.prototype.getMaxListeners=function(){return K(this)},v.prototype.emit=function(c){for(var m=[],y=1;y<arguments.length;y++)m.push(arguments[y]);var L=c==="error",A=this._events;if(A!==void 0)L=L&&A.error===void 0;else if(!L)return!1;if(L){var C;if(m.length>0&&(C=m[0]),C instanceof Error)throw C;var G=new Error("Unhandled error."+(C?" ("+C.message+")":""));throw G.context=C,G}var le=A[c];if(le===void 0)return!1;if(typeof le=="function")l(le,this,m);else for(var Xe=le.length,Wt=ce(le,Xe),y=0;y<Xe;++y)l(Wt[y],this,m);return!0};function ie(d,c,m,y){var L,A,C;if(U(m),A=d._events,A===void 0?(A=d._events=Object.create(null),d._eventsCount=0):(A.newListener!==void 0&&(d.emit("newListener",c,m.listener?m.listener:m),A=d._events),C=A[c]),C===void 0)C=A[c]=m,++d._eventsCount;else if(typeof C=="function"?C=A[c]=y?[m,C]:[C,m]:y?C.unshift(m):C.push(m),L=K(d),L>0&&C.length>L&&!C.warned){C.warned=!0;var G=new Error("Possible EventEmitter memory leak detected. "+C.length+" "+String(c)+" listeners added. Use emitter.setMaxListeners() to increase limit");G.name="MaxListenersExceededWarning",G.emitter=d,G.type=c,G.count=C.length,b(G)}return d}v.prototype.addListener=function(c,m){return ie(this,c,m,!1)},v.prototype.on=v.prototype.addListener,v.prototype.prependListener=function(c,m){return ie(this,c,m,!0)};function we(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function J(d,c,m){var y={fired:!1,wrapFn:void 0,target:d,type:c,listener:m},L=we.bind(y);return L.listener=m,y.wrapFn=L,L}v.prototype.once=function(c,m){return U(m),this.on(c,J(this,c,m)),this},v.prototype.prependOnceListener=function(c,m){return U(m),this.prependListener(c,J(this,c,m)),this},v.prototype.removeListener=function(c,m){var y,L,A,C,G;if(U(m),L=this._events,L===void 0)return this;if(y=L[c],y===void 0)return this;if(y===m||y.listener===m)--this._eventsCount===0?this._events=Object.create(null):(delete L[c],L.removeListener&&this.emit("removeListener",c,y.listener||m));else if(typeof y!="function"){for(A=-1,C=y.length-1;C>=0;C--)if(y[C]===m||y[C].listener===m){G=y[C].listener,A=C;break}if(A<0)return this;A===0?y.shift():Ee(y,A),y.length===1&&(L[c]=y[0]),L.removeListener!==void 0&&this.emit("removeListener",c,G||m)}return this},v.prototype.off=v.prototype.removeListener,v.prototype.removeAllListeners=function(c){var m,y,L;if(y=this._events,y===void 0)return this;if(y.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):y[c]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete y[c]),this;if(arguments.length===0){var A=Object.keys(y),C;for(L=0;L<A.length;++L)C=A[L],C!=="removeListener"&&this.removeAllListeners(C);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(m=y[c],typeof m=="function")this.removeListener(c,m);else if(m!==void 0)for(L=m.length-1;L>=0;L--)this.removeListener(c,m[L]);return this};function pe(d,c,m){var y=d._events;if(y===void 0)return[];var L=y[c];return L===void 0?[]:typeof L=="function"?m?[L.listener||L]:[L]:m?kt(L):ce(L,L.length)}v.prototype.listeners=function(c){return pe(this,c,!0)},v.prototype.rawListeners=function(c){return pe(this,c,!1)},v.listenerCount=function(d,c){return typeof d.listenerCount=="function"?d.listenerCount(c):ee.call(d,c)},v.prototype.listenerCount=ee;function ee(d){var c=this._events;if(c!==void 0){var m=c[d];if(typeof m=="function")return 1;if(m!==void 0)return m.length}return 0}v.prototype.eventNames=function(){return this._eventsCount>0?f(this._events):[]};function ce(d,c){for(var m=new Array(c),y=0;y<c;++y)m[y]=d[y];return m}function Ee(d,c){for(;c+1<d.length;c++)d[c]=d[c+1];d.pop()}function kt(d){for(var c=new Array(d.length),m=0;m<c.length;++m)c[m]=d[m].listener||d[m];return c}function xt(d,c){return new Promise(function(m,y){function L(C){d.removeListener(c,A),y(C)}function A(){typeof d.removeListener=="function"&&d.removeListener("error",L),m([].slice.call(arguments))}Ze(d,c,A,{once:!0}),c!=="error"&&Nt(d,L,{once:!0})})}function Nt(d,c,m){typeof d.on=="function"&&Ze(d,"error",c,m)}function Ze(d,c,m,y){if(typeof d.on=="function")y.once?d.once(c,m):d.on(c,m);else if(typeof d.addEventListener=="function")d.addEventListener(c,function L(A){y.once&&d.removeEventListener(c,L),m(A)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof d)}}},u={};function P(w){var g=u[w];if(g!==void 0)return g.exports;var l=u[w]={exports:{}};return a[w](l,l.exports,P),l.exports}P.g=function(){if(typeof globalThis=="object")return globalThis;try{return this||new Function("return this")()}catch{if(typeof window=="object")return window}}();var T=P(46);class s extends T.EventEmitter{listenerCount(g){return super.listenerCount(g)}}const $="storage_v2",W=()=>({origin:{}});let F=W();const z=()=>{const w=localStorage.getItem($);return w?JSON.parse(w):W()};class B extends s{save(g,l=!1){if(l||!P.g.window){F=g(F);return}try{const f=g(z());localStorage.setItem($,JSON.stringify(f)),this.emit("changed",f)}catch{console.warn("long term storage not available"),F=g(F)}}saveForOrigin(g,l,f=!1){this.save(b=>{var I;return{...b,origin:{...b.origin,[l]:g(((I=b.origin)==null?void 0:I[l])||{})}}},f)}load(g=!1){var l,f;if(g||!((f=(l=P.g)==null?void 0:l.window)!=null&&f.localStorage))return F;try{return z()}catch{return console.warn("long term storage not available"),F}}loadForOrigin(g,l=!1){var b;return((b=this.load(l).origin)==null?void 0:b[g])||{}}}new B;const Q=w=>{let g=()=>{},l=()=>{};const f=new Promise((b,I)=>{g=b,l=I});return{id:w,resolve:g,reject:l,promise:f}},be=w=>Array.isArray(w),_e=()=>new Error("Aborted by signal"),Pe=()=>new Error("Aborted by deadline"),ye=()=>new Error("Aborted by timeout"),h=(w,g)=>new Promise((l,f)=>{if(g.aborted)return f();if(w===void 0)return l();let b;const I=()=>{clearTimeout(b),g.removeEventListener("abort",I),f()};b=setTimeout(()=>{g.removeEventListener("abort",I),l()},w),g.addEventListener("abort",I)}),r=(w,g,l)=>new Promise((f,b)=>{if(l.aborted)return b();let I;const v=()=>{clearTimeout(I),l.removeEventListener("abort",v),b()};I=setTimeout(()=>{l.removeEventListener("abort",v),b(g())},w),l.addEventListener("abort",v)}),p=(w,g,l)=>w===void 0?[]:[r(w,g,l)],_=(w,g)=>new Promise((l,f)=>{if(g.aborted)return f();if(w!=null&&w.aborted)return f(_e());const b=()=>f(_e());w==null||w.addEventListener("abort",b);const I=()=>{w==null||w.removeEventListener("abort",b),g.removeEventListener("abort",I),f()};g.addEventListener("abort",I)}),E=async(w,g)=>{const l=new AbortController;g.aborted&&l.abort();const f=()=>{g.removeEventListener("abort",f),l.abort()};g.addEventListener("abort",f);try{return await new Promise(b=>b(w(l.signal)))}finally{g.aborted||g.removeEventListener("abort",f)}},O=async(w,g,l,f)=>{for(let b=0;b<w-1&&!f.aborted;b++){const I=new AbortController,v=()=>I.abort();f.addEventListener("abort",v);try{return await g(b,I.signal)}catch(H){v(),await l(b,H)}finally{f.removeEventListener("abort",v)}}return f.aborted?Promise.reject():g(w-1,f)},S=async(w,g)=>{const{signal:l,delay:f,attempts:b,timeout:I,deadline:v,gap:H,attemptFailureHandler:U}=g,K=v&&v-Date.now(),ie=be(b)?b.length:b??(v?1/0:1),we=new AbortController,J=we.signal,pe=be(b)?ee=>b[ee]:()=>({timeout:I,gap:H});try{return await Promise.race([_(l,J),...p(K,Pe,J),h(f,J).then(()=>O(ie,(ee,ce)=>Promise.race([...p(pe(ee).timeout,ye,J),E(w,ce)]),(ee,ce)=>{const Ee=U==null?void 0:U(ce);return Ee?Promise.reject(Ee):h(pe(ee).gap??0,J)},J))])}finally{we.abort()}};class j extends s{constructor({sendFn:l,channel:f,logger:b,lazyHandshake:I=!1,legacyMode:v=!1}){super();R(this,"messagePromises",{});R(this,"messagesQueue",[]);R(this,"messageID",0);R(this,"isConnected",!1);R(this,"handshakeMaxRetries",5);R(this,"handshakeRetryInterval",2e3);this.channel=f,this.sendFn=l,this.lazyHandshake=I,this.legacyMode=v,this.logger=b}init(){return this.handshakeFinished||(this.handshakeFinished=Q(),this.legacyMode&&setTimeout(()=>{var l;(l=this.handshakeFinished)==null||l.resolve()},500),this.lazyHandshake||this.handshakeWithPeer()),this.handshakeFinished.promise}handshakeWithPeer(){var l;return(l=this.logger)==null||l.log(this.channel.here,"handshake"),S(async()=>{var f;this.postMessage({type:"channel-handshake-request",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),await((f=this.handshakeFinished)==null?void 0:f.promise)},{attempts:this.handshakeMaxRetries,timeout:this.handshakeRetryInterval}).then(()=>{var f;(f=this.logger)==null||f.log(this.channel.here,"handshake confirmed"),this.messagesQueue.forEach(b=>{b.channel=this.channel,this.sendFn(b)}),this.messagesQueue=[]}).catch(()=>{var f;(f=this.handshakeFinished)==null||f.reject(new Error("handshake failed")),this.handshakeFinished=void 0})}onMessage(l){var K,ie;let f=l;this.legacyMode&&f.type===void 0&&"data"in f&&typeof f.data=="object"&&f.data!==null&&"type"in f.data&&typeof f.data.type=="string"&&(f=f.data);const{channel:b,id:I,type:v,...H}=f;if(!this.legacyMode&&(!(b!=null&&b.peer)||b.peer!==this.channel.here||!(b!=null&&b.here)||this.channel.peer!==b.here))return;if(v==="channel-handshake-request"){this.postMessage({type:"channel-handshake-confirm",data:{success:!0,payload:void 0}},{usePromise:!1,useQueue:!1}),this.lazyHandshake&&this.handshakeWithPeer();return}if(v==="channel-handshake-confirm"){(K=this.handshakeFinished)==null||K.resolve(void 0);return}this.messagePromises[I]&&(this.messagePromises[I].resolve({id:I,...H}),delete this.messagePromises[I]);const U=Object.keys(this.messagePromises).length;U>5&&((ie=this.logger)==null||ie.warn(`too many message promises (${U}). this feels unexpected!`)),this.emit("message",f)}postMessage(l,{usePromise:f=!0,useQueue:b=!0}={}){if(l.channel=this.channel,!f){try{this.sendFn(l)}catch{b&&this.messagesQueue.push(l)}return}this.messageID++,l.id=this.messageID,this.messagePromises[l.id]=Q();try{this.sendFn(l)}catch{b&&this.messagesQueue.push(l)}return this.messagePromises[l.id].promise}resolveMessagePromises(l){Object.keys(this.messagePromises).forEach(f=>this.messagePromises[f].resolve({id:f,payload:l}))}clear(){this.handshakeFinished=void 0}}class se extends j{constructor({name:g,channel:l}){super({channel:l,sendFn:b=>{if(!this.port)throw new Error("port not assigned");this.port.postMessage(b)}});const f=chrome.runtime.connect({name:g});this.port=f,this.connect()}connect(){var g;(g=this.port)==null||g.onMessage.addListener(l=>{l.channel.here!==this.channel.here&&this.onMessage(l)}),this.isConnected=!0}disconnect(){var g;this.isConnected&&((g=this.port)==null||g.disconnect(),this.isConnected=!1)}}const ae={BOOTSTRAP:"popup-bootstrap",LOADED:"popup-loaded",CORE_LOADED:"popup-core-loaded",INIT:"popup-init",ERROR:"popup-error",EXTENSION_USB_PERMISSIONS:"open-usb-permissions",HANDSHAKE:"popup-handshake",CLOSED:"popup-closed",CANCEL_POPUP_REQUEST:"ui-cancel-popup-request",CLOSE_WINDOW:"window.close",ANALYTICS_RESPONSE:"popup-analytics-response",CONTENT_SCRIPT_LOADED:"popup-content-script-loaded",METHOD_INFO:"popup-method-info"};"9.4.5".split(".").map(w=>parseInt(w,10));const Rt=1;function Dt(){const g=new URLSearchParams(window.location.search).get("extension-id");if(g&&g!==chrome.runtime.id)return;const l=new se({name:"trezor-connect",channel:{here:"@trezor/connect-content-script",peer:"@trezor/connect-webextension"}}),f=[];let b=!1;function I(v){return JSON.parse(JSON.stringify(v))}window.addEventListener("message",v=>{var H,U,K;((U=(H=v.data)==null?void 0:H.channel)==null?void 0:U.here)!=="@trezor/connect-webextension"&&(((K=v.data)==null?void 0:K.type)===ae.LOADED&&window.postMessage({type:ae.CONTENT_SCRIPT_LOADED,payload:{...chrome.runtime.getManifest(),id:chrome.runtime.id,contentScriptVersion:Rt}},window.location.origin),v.source===window&&v.data&&(b?l.postMessage(I(v.data),{usePromise:!1}):f.push(v.data)))}),l.init().then(()=>{for(b=!0,l.on("message",v=>{window.postMessage(I(v),window.location.origin)});f.length>0;){const v=f.shift();l.postMessage(I(v),{usePromise:!1})}window.addEventListener("beforeunload",()=>{window.postMessage({type:ae.CLOSED},window.location.origin)})})}Dt()})()}}).then(()=>{this.logger.debug("content script injected")}).catch(a=>{throw this.logger.error("content script injection error",a),a}),{attempts:new Array(3).fill({timeout:100})})})});if(this.settings=n,this.origin=yt(n.popupSrc),this.logger=e,this.isWebExtensionWithTab()?this.channel=new Ge({name:"trezor-connect",channel:{here:"@trezor/connect-webextension",peer:"@trezor/connect-content-script"},logger:e,currentId:()=>{var a,u;if(((a=this.popupWindow)==null?void 0:a.mode)==="tab")return(u=this.popupWindow)==null?void 0:u.tab.id},legacyMode:!this.settings.useCoreInPopup}):this.channel=new Ke({windowHere:window,windowPeer:()=>{var a,u;if(((a=this.popupWindow)==null?void 0:a.mode)==="window")return(u=this.popupWindow)==null?void 0:u.window},channel:{here:"@trezor/connect-web",peer:"@trezor/connect-popup"},logger:e,origin:this.origin,legacyMode:!this.settings.useCoreInPopup}),this.settings.useCoreInPopup||(this.iframeHandshakePromise=ne(ge.LOADED),this.channelIframe=new Ke({windowHere:window,windowPeer:()=>window,channel:{here:"@trezor/connect-web",peer:"@trezor/connect-iframe"},logger:e,origin:this.origin}),(o=this.channelIframe)==null||o.on("message",this.handleMessage.bind(this))),this.settings.useCoreInPopup){this.handshakePromise=ne(),this.channel.on("message",this.handleCoreMessage.bind(this));return}else this.isWebExtensionWithTab()?this.channel.on("message",this.handleExtensionMessage.bind(this)):this.channel.on("message",this.handleMessage.bind(this));this.channel.init()}async request(){var o,a,u,P,T;if(this.settings.useCoreInPopup&&((o=this.popupWindow)==null?void 0:o.mode)==="tab"&&(await Et((u=(a=this.popupWindow)==null?void 0:a.tab)==null?void 0:u.id)||this.clear()),this.locked){((P=this.popupWindow)==null?void 0:P.mode)==="tab"&&this.popupWindow.tab.id?chrome.tabs.update(this.popupWindow.tab.id,{active:!0}):((T=this.popupWindow)==null?void 0:T.mode)==="window"&&this.popupWindow.window.focus();return}this.popupWindow&&!this.locked&&this.close();const n=this.open.bind(this);this.locked=!0;const e=this.settings.env==="webextension"?1:Lt;this.requestTimeout=setTimeout(()=>{this.requestTimeout=void 0,n()},e)}unlock(){this.locked=!1}open(){const n=this.settings.popupSrc;this.popupPromise=ne(M.LOADED);const e=this.buildPopupUrl(n);this.openWrapper(e),this.closeInterval=setInterval(()=>{this.popupWindow&&(this.popupWindow.mode==="tab"&&this.popupWindow.tab.id?chrome.tabs.get(this.popupWindow.tab.id,o=>{o||(this.emitClosed(),this.clear())}):this.popupWindow.mode==="window"&&this.popupWindow.window.closed&&(this.clear(),this.emitClosed()))},St),!this.settings.useCoreInPopup&&(this.openTimeout=setTimeout(()=>{this.clear(),Qe(this.open.bind(this),()=>{this.emitClosed()})},Ct))}buildPopupUrl(n){var o;const e=new URLSearchParams;return e.set("version",de),e.set("env",this.settings.env),this.settings.env==="webextension"&&((o=chrome==null?void 0:chrome.runtime)!=null&&o.id)&&(e.set("extension-id",chrome.runtime.id),e.set("cs-ver",Ce.toString())),n+"?"+e.toString()}openWrapper(n){if(this.isWebExtensionWithTab())chrome.windows.getCurrent(e=>{this.logger.debug("opening popup. currentWindow: ",e),e.type!=="normal"?chrome.windows.create({url:n},o=>{chrome.tabs.query({windowId:o==null?void 0:o.id,active:!0},a=>{this.popupWindow={mode:"tab",tab:a[0]},this.injectContentScript(a[0].id)})}):chrome.tabs.query({currentWindow:!0,active:!0},o=>{this.extensionTabId=o[0].id,chrome.tabs.create({url:n,index:o[0].index+1},a=>{this.popupWindow={mode:"tab",tab:a},this.injectContentScript(a.id)})})});else{const e=window.open(n,"modal");if(!e)return;this.popupWindow={mode:"window",window:e}}this.channel.isConnected||this.channel.connect()}handleCoreMessage(n){var e;if(n.type===M.BOOTSTRAP)this.channel.init();else if(n.type===M.LOADED)this.handleMessage(n),this.channel.postMessage({type:M.INIT,payload:{settings:this.settings,useCore:!0}});else if(n.type===M.CORE_LOADED)this.channel.postMessage({type:M.HANDSHAKE,payload:{settings:this.settings}}),(e=this.handshakePromise)==null||e.resolve();else if(n.type===M.CLOSED)this.emitClosed();else if(n.type===M.CONTENT_SCRIPT_LOADED){const{contentScriptVersion:o}=n.payload;o!==Ce&&console.warn(`Content script version mismatch. Expected ${Ce}, got ${o}`)}}handleExtensionMessage(n){n.type===M.ERROR||n.type===M.LOADED||n.type===M.BOOTSTRAP?this.handleMessage(n):n.type===M.EXTENSION_USB_PERMISSIONS?chrome.tabs.query({currentWindow:!0,active:!0},e=>{chrome.tabs.create({url:"trezor-usb-permissions.html",index:e[0].index+1},o=>{})}):n.type===M.CLOSE_WINDOW&&this.clear()}handleMessage(n){var e,o;if(n.type===ge.LOADED)(e=this.iframeHandshakePromise)==null||e.resolve(n.payload);else if(n.type===M.BOOTSTRAP)this.openTimeout&&clearTimeout(this.openTimeout);else if(n.type===M.ERROR&&this.popupWindow){const a=n.payload&&typeof n.payload.error=="string"?n.payload.error:null;this.emit(M.CLOSED,a?`Popup error: ${a}`:null),this.clear()}else n.type===M.LOADED?(this.openTimeout&&clearTimeout(this.openTimeout),this.popupPromise&&(this.popupPromise.resolve(),this.popupPromise=void 0),(o=this.iframeHandshakePromise)==null||o.promise.then(a=>{this.channel.postMessage({type:M.INIT,payload:{...a,settings:this.settings}})})):n.type===M.CANCEL_POPUP_REQUEST?(clearTimeout(this.requestTimeout),this.popupPromise&&this.close(),this.unlock()):n.type===V.CLOSE_UI_WINDOW&&this.clear(!1)}clear(n=!0){this.locked=!1,this.popupPromise=void 0,this.handshakePromise=ne(),this.channel&&this.channel.disconnect(),this.requestTimeout&&(clearTimeout(this.requestTimeout),this.requestTimeout=void 0),this.openTimeout&&(clearTimeout(this.openTimeout),this.openTimeout=void 0),this.closeInterval&&(clearInterval(this.closeInterval),this.closeInterval=void 0),n&&this.extensionTabId&&(chrome.tabs.update(this.extensionTabId,{active:!0}),this.extensionTabId=0)}close(){var n;if(this.popupWindow){if(this.logger.debug("closing popup"),this.popupWindow.mode==="tab"){let e=chrome.runtime.lastError;this.popupWindow.tab.id&&chrome.tabs.remove(this.popupWindow.tab.id,()=>{e=chrome.runtime.lastError,e&&this.logger.error("closed with error",e)})}else this.popupWindow.mode==="window"&&this.popupWindow.window.close();this.popupWindow=void 0,(n=this.settings)!=null&&n.useCoreInPopup&&this.channel.clear()}}async postMessage(n){var e,o;if(!this.popupWindow&&n.type!==V.REQUEST_UI_WINDOW&&this.openTimeout){this.clear(),Qe(this.open.bind(this),()=>{this.emitClosed()});return}this.popupPromise&&await this.popupPromise.promise,((e=this.popupWindow)==null?void 0:e.mode)==="window"?this.popupWindow.window.postMessage(n,this.origin):((o=this.popupWindow)==null?void 0:o.mode)==="tab"&&this.channel.postMessage(n)}isWebExtensionWithTab(){var n;return((n=this.settings)==null?void 0:n.env)==="webextension"&&typeof chrome<"u"&&typeof(chrome==null?void 0:chrome.tabs)<"u"}emitClosed(){var n;(n=this.settings)!=null&&n.useCoreInPopup&&this.channel.resolveMessagePromises({code:"Method_Interrupted",error:M.CLOSED}),this.emit(M.CLOSED)}}class Je{constructor(){R(this,"eventEmitter",new(De()));this._settings=ue(),this.logger=me("@trezor/connect-web"),this.popupManagerLogger=me("@trezor/connect-web/popupManager")}logWriterFactory(t){return{add:n=>{t.channel.postMessage({event:Oe,type:ge.LOG,payload:n},{usePromise:!1,useQueue:!0})}}}manifest(t){this._settings=ue({...this._settings,manifest:t})}dispose(){return this.eventEmitter.removeAllListeners(),this._settings=ue(),this._popupManager&&this._popupManager.close(),Promise.resolve(void 0)}cancel(t){this._popupManager&&this._popupManager.emit(M.CLOSED,t)}init(t){var a,u;const n=ue({...this._settings}),e=ue({...this._settings,...t});(a=e.transports)!=null&&a.length||(e.transports=["BridgeTransport","WebUsbTransport"]),e.useCoreInPopup=!0,typeof window<"u"&&((u=window==null?void 0:window.location)!=null&&u.origin)&&(e.origin=window.location.origin);const o=JSON.stringify(n)===JSON.stringify(e);if(this._settings=e,(!this._popupManager||!o)&&(this._popupManager&&this._popupManager.close(),this._popupManager=new It(this._settings,{logger:this.popupManagerLogger}),it(()=>this.logWriterFactory(this._popupManager))),this.logger.enabled=!!t.debug,!this._settings.manifest)throw X("Init_ManifestMissing");return this.logger.debug("initiated"),Promise.resolve()}async call(t){if(this.logger.debug("call",t),!this._popupManager)return Ve(X("Init_NotInitialized"));this._settings.popup&&await this._popupManager.request();const n=ne(),e=()=>{this.logger.log("Popup closed during initialization"),n.reject(X("Method_Interrupted"))};this._popupManager.once(M.CLOSED,e);try{this.logger.debug("call: popup initialing"),await Promise.race([n.promise,this.callInit()]),this.logger.debug("call: popup initialized");const o=await this._popupManager.channel.postMessage({type:ge.CALL,payload:t});if(this.logger.debug("call: response: ",o),o)return this._popupManager&&o.success&&this._popupManager.clear(),{success:o.success,payload:o.payload,device:o.device};throw X("Method_NoResponse")}catch(o){return this.logger.error("call: error",o),this._popupManager.clear(!1),Ve(o)}finally{this._popupManager.removeListener(M.CLOSED,e)}}async callInit(){var t,n;if(!this._popupManager)throw X("Init_NotInitialized");await this._popupManager.channel.init(),this._settings.env==="webextension"&&(await((t=this._popupManager.popupPromise)==null?void 0:t.promise),this._popupManager.channel.postMessage({type:M.INIT,payload:{settings:this._settings,useCore:!0}})),await((n=this._popupManager.handshakePromise)==null?void 0:n.promise)}uiResponse(t){var o,a;const{type:n,payload:e}=t;(a=(o=this._popupManager)==null?void 0:o.channel)==null||a.postMessage({event:Oe,type:n,payload:e})}renderWebUSBButton(){}requestLogin(){throw X("Method_InvalidPackage")}disableWebUSB(){throw X("Method_InvalidPackage")}requestWebUSBDevice(){throw X("Method_InvalidPackage")}}const k=new Je;Me({eventEmitter:k.eventEmitter,init:k.init.bind(k),call:k.call.bind(k),manifest:k.manifest.bind(k),requestLogin:k.requestLogin.bind(k),uiResponse:k.uiResponse.bind(k),cancel:k.cancel.bind(k),dispose:k.dispose.bind(k)});const Tt=()=>"webextension",ve=(i={})=>{const t={popup:!0,...i};return typeof i.env!="string"&&(t.env=Tt()),$e(t)},Pt=ve(),Ot=()=>{chrome.runtime.onMessage.addListener(()=>!1)};class Mt extends Je{constructor(){super(),this._settings=ve(),this.logger=me("@trezor/connect-webextension"),this.popupManagerLogger=me("@trezor/connect-webextension/popupManager")}init(t){return t._extendWebextensionLifetime&&Ot(),super.init(t)}}const x=new Mt,Te=Me({eventEmitter:x.eventEmitter,init:x.init.bind(x),call:x.call.bind(x),manifest:x.manifest.bind(x),requestLogin:x.requestLogin.bind(x),uiResponse:x.uiResponse.bind(x),cancel:x.cancel.bind(x),dispose:x.dispose.bind(x)});(()=>{const i=new Ge({name:"trezor-connect-proxy",channel:{here:"@trezor/connect-service-worker-proxy",peer:"@trezor/connect-foreground-proxy"},lazyHandshake:!0,allowSelfOrigin:!0});let t=ve();i.init(),i.on("message",n=>{const{id:e,payload:o,type:a}=n;if(!o)return;const{method:u,settings:P}=o;if(a===M.INIT){t=ve({...Pt,...P});return}Te.init(t).then(()=>{Te[u](o).then(T=>{i.postMessage({...T,id:e})})})})})();const At=Te;return fe=fe.default,fe})())})(et);var jt=et.exports;const Yt=Ut(jt);export{Yt as T};
